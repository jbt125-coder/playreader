<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pro Performance Engine</title>
<style>
    body { margin:0; font-family:-apple-system, Arial; background:#000; color:white; text-align:center; padding-bottom:100px; overflow-x: hidden; }
    
    /* Sticky Control Panel */
    .controls { position: sticky; top: 0; background: #111; padding: 12px; z-index: 1000; border-bottom: 2px solid #AF52DE; }
    .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; margin: 3px; -webkit-appearance: none; }
    .play { background: #34C759; color: white; width: 45%; }
    .stop { background: #FF3B30; color: white; width: 45%; }
    .beat-master { background: #444; color: white; width: 94%; margin-top:8px; font-size: 15px; }
    .beat-active { background: #AF52DE !important; box-shadow: 0 0 15px #AF52DE; }
    
    .slider-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; padding: 0 10px; }
    .slider-row label { font-size: 11px; color: #AF52DE; font-weight: bold; width: 100px; }
    input[type=range] { flex-grow: 1; }

    /* iOS Voice Help */
    .ios-help { background: #1a1a2e; margin: 10px; padding: 12px; border-radius: 10px; border: 1px solid #0A84FF; font-size: 11px; text-align: left; }
    .ios-help strong { color: #0A84FF; }

    /* Character Styling */
    .character-card { background: #1a1a1a; margin: 10px; padding: 15px; border-radius: 15px; border: 1px solid #333; text-align: left; }
    .active-char { border: 2px solid #34C759 !important; background: #222; }
    
    .char-header { color: #34C759; font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block; }
    textarea { width: 100%; height: 60px; margin: 5px 0; border-radius: 8px; border: none; padding: 8px; font-size: 16px; background: #fff; color: #000; box-sizing: border-box; }
    
    .phrase-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; }
    .phrase-grid input { padding: 8px; border-radius: 6px; border: none; font-size: 12px; background: #ddd; color: #000; width: 100%; box-sizing: border-box; }
    .phrase-label { font-size: 10px; color: #AF52DE; font-weight: bold; margin-bottom: 2px; }
    
    select { width: 100%; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; background: #333; color: white; border: 1px solid #444; -webkit-appearance: none; }
    
    /* Log System */
    #save-log { margin: 20px 10px; padding: 15px; background: #111; border: 1px dashed #444; border-radius: 15px; text-align: left; }
    .log-item { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 12px; border-left: 4px solid #AF52DE; }
    .log-item button { background: #0A84FF; color: white; border: none; padding: 5px 10px; border-radius: 5px; margin-top: 5px; font-size: 10px; }
</style>
</head>
<body>

<div class="controls">
    <button class="btn play" onclick="startPerformance()">‚ñ∂ START DIALOGUE</button>
    <button class="btn stop" onclick="stopAll()">STOP ALL</button>
    
    <div class="slider-row">
        <label id="bpmLabel">START BPM: 80</label>
        <input type="range" id="startBPM" min="40" max="180" value="80" oninput="updateStartingBPM(this.value)">
    </div>

    <button id="masterBeatBtn" class="btn beat-master" onclick="toggleMasterBeat()">ü•Å BEAT IS OFF</button>
    <button class="btn" style="background:#FF9500; color:white; width:94%; margin-top:5px;" onclick="refreshVoices()">üîÑ REFRESH VOICES</button>
    <button class="btn" style="background:#FF2D55; color:white; width:94%; margin-top:5px;" onclick="showVoiceInspector()">üîç FIND MY VOICES</button>
    <button class="btn" style="background:#0A84FF; color:white; width:94%; margin-top:5px;" onclick="saveCurrentToLog()">üíæ SAVE PERFORMANCE TO LOG</button>
</div>

<div id="voiceInspector" style="display:none; background:#1a1a2e; margin:10px; padding:15px; border-radius:10px; border:2px solid #FF2D55;">
    <h3 style="color:#FF2D55; font-size:14px; margin-top:0;">üîç VOICE INSPECTOR</h3>
    <div id="voiceList" style="max-height:300px; overflow-y:auto; font-size:11px; line-height:1.6;"></div>
    <button class="btn" style="background:#FF3B30; width:100%; margin-top:10px;" onclick="hideVoiceInspector()">CLOSE</button>
</div>

<div class="ios-help">
    <strong>üì± GET MORE iPHONE VOICES:</strong><br>
    Settings ‚Üí Accessibility ‚Üí Spoken Content ‚Üí Voices ‚Üí Download new voices (English or other languages). Try "Samantha (Enhanced)" or "Ava (Premium)" for high quality!
</div>

<div id="characterContainer"></div>

<div id="save-log">
    <h3 style="font-size: 14px; color: #AF52DE; margin-top:0;">üìÅ SAVED LOGS</h3>
    <div id="logItems"></div>
</div>

<script>
let voices = [];
let isRunning = false;
let masterBeatOn = false;
let currentBPM = 80;
let audioCtx = null;
let patternPos = 0;
let beatTimeout = null;
let currentActiveChar = 1;

const patterns = {
    "steady": [1, 0, 1, 0],
    "five_fast": [1, 1, 1, 1, 1, 0, 0, 0],
    "one_three": [1, 0, 0, 0, 1, 1, 1, 0],
    "two_two": [1, 1, 0, 0, 1, 1, 0, 0],
    "frantic_20": [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0]
};

function init() {
    const container = document.getElementById('characterContainer');
    for (let i = 1; i <= 5; i++) {
        container.innerHTML += `
            <div class="character-card" id="card_${i}">
                <span class="char-header">CHARACTER ${i}</span>
                <select id="voice_${i}" class="voice-sel"></select>
                <textarea id="text_${i}" placeholder="Use *1 *2 *3 to insert phrases...">Character ${i} is ready. *1 Dial in the rhythm. *2 Let's perform.</textarea>
                <div class="phrase-grid">
                    <div>
                        <div class="phrase-label">PHRASE 1 (*1)</div>
                        <input type="text" id="c${i}_p1" value="WAIT!">
                    </div>
                    <div>
                        <div class="phrase-label">PHRASE 2 (*2)</div>
                        <input type="text" id="c${i}_p2" value="Look.">
                    </div>
                    <div>
                        <div class="phrase-label">PHRASE 3 (*3)</div>
                        <input type="text" id="c${i}_p3" value="LISTEN.">
                    </div>
                </div>
                <select id="beat_select_${i}">
                    <option value="steady" ${i==1?'selected':''}>Steady Pulse</option>
                    <option value="five_fast" ${i==2?'selected':''}>5 Fast Beats</option>
                    <option value="one_three" ${i==3?'selected':''}>1 then 3</option>
                    <option value="two_two" ${i==4?'selected':''}>2 Pause 2</option>
                    <option value="frantic_20" ${i==5?'selected':''}>20 Fast Beats</option>
                </select>
            </div>`;
    }
    renderLog();
}

function updateStartingBPM(val) {
    currentBPM = parseInt(val);
    document.getElementById('bpmLabel').textContent = "START BPM: " + val;
}

function loadVoices() {
    voices = window.speechSynthesis.getVoices();
    if (voices.length === 0) return;
    
    // Log all voices to console for debugging
    console.log("=== ALL AVAILABLE VOICES ===");
    voices.forEach((v, i) => {
        console.log(`${i}: ${v.name} | ${v.lang} | local:${v.localService}`);
    });
    
    // AGGRESSIVE VOICE FINDER - strips all special chars and matches partial
    function findVoiceAggressive(targetName) {
        const cleanTarget = targetName.toLowerCase().replace(/[^a-z]/g, '');
        
        // Try multiple search strategies
        let found = -1;
        
        // Strategy 1: Exact match in cleaned name
        found = voices.findIndex(v => {
            const cleanName = v.name.toLowerCase().replace(/[^a-z]/g, '');
            return cleanName === cleanTarget;
        });
        if (found !== -1) return found;
        
        // Strategy 2: Target name is contained in voice name
        found = voices.findIndex(v => {
            const cleanName = v.name.toLowerCase().replace(/[^a-z]/g, '');
            return cleanName.includes(cleanTarget);
        });
        if (found !== -1) return found;
        
        // Strategy 3: Voice name starts with target
        found = voices.findIndex(v => {
            const cleanName = v.name.toLowerCase().replace(/[^a-z]/g, '');
            return cleanName.startsWith(cleanTarget);
        });
        if (found !== -1) return found;
        
        // Strategy 4: Simple includes (original case-insensitive)
        found = voices.findIndex(v => v.name.toLowerCase().includes(targetName.toLowerCase()));
        if (found !== -1) return found;
        
        // Strategy 5: Check if any word in voice name matches
        found = voices.findIndex(v => {
            const words = v.name.toLowerCase().split(/[\s\-_()]+/);
            return words.some(word => word.includes(cleanTarget) || cleanTarget.includes(word));
        });
        if (found !== -1) return found;
        
        // Strategy 6: Prioritize local/downloaded voices with similar names
        found = voices.findIndex(v => {
            if (!v.localService) return false;
            const cleanName = v.name.toLowerCase().replace(/[^a-z]/g, '');
            return cleanName.includes(cleanTarget.substring(0, 3)); // Match first 3 letters
        });
        if (found !== -1) return found;
        
        return -1; // Not found
    }
    
    // FORCE FIND specific voices for each character
    const targetVoices = ['matilda', 'ava', 'zoe', 'karen', 'kate'];
    const foundVoiceIndices = [];
    
    console.log("\n=== SEARCHING FOR TARGET VOICES ===");
    targetVoices.forEach(targetName => {
        const found = findVoiceAggressive(targetName);
        foundVoiceIndices.push(found !== -1 ? found : 0);
        if (found !== -1) {
            console.log(`‚úÖ FOUND: ${targetName} at index ${found} - ${voices[found].name}`);
        } else {
            console.log(`‚ùå NOT FOUND: ${targetName} - using fallback voice`);
        }
    });
    
    // Separate voices by quality - Premium and Enhanced go first
    const premiumVoices = [];
    const enhancedVoices = [];
    const regularVoices = [];
    
    // Premium voice names (known iOS premium voices)
    const premiumNames = ['ava', 'zoe', 'reed', 'evan', 'allison', 'stephanie', 'gordon', 'karen', 'laura', 'emily', 'fiona', 'daniel', 'alice', 'oliver', 'martha', 'matilda'];
    
    // Enhanced voice names (known iOS enhanced voices)
    const enhancedNames = ['samantha', 'alex', 'nicky', 'sara', 'kate', 'serena', 'aaron'];
    
    voices.forEach((v, i) => {
        const name = v.name.toLowerCase();
        const lang = v.lang.toLowerCase();
        
        // Check if it's a premium voice by name
        const isPremium = premiumNames.some(pName => name.includes(pName));
        
        // Check if it's enhanced
        const isEnhanced = enhancedNames.some(eName => name.includes(eName)) || 
                          name.includes('enhanced') || 
                          name.includes('quality') ||
                          name.includes('premium');
        
        // Prioritize English voices and local (downloaded) voices
        const isLocal = v.localService;
        const isEnglish = lang.startsWith('en');
        
        if (isPremium && isLocal) {
            premiumVoices.push({voice: v, index: i});
        } else if (isEnhanced && isLocal) {
            enhancedVoices.push({voice: v, index: i});
        } else {
            regularVoices.push({voice: v, index: i});
        }
    });
    
    console.log(`Found: ${premiumVoices.length} premium, ${enhancedVoices.length} enhanced, ${regularVoices.length} standard`);
    
    // Combine with premium/enhanced at top
    const sortedVoices = [...premiumVoices, ...enhancedVoices, ...regularVoices];
    
    document.querySelectorAll('.voice-sel').forEach((sel, idx) => {
        let html = '';
        
        // Add premium section
        if (premiumVoices.length > 0) {
            html += '<optgroup label="‚≠ê PREMIUM VOICES">';
            premiumVoices.forEach(v => {
                html += `<option value="${v.index}">${v.voice.name} (${v.voice.lang})</option>`;
            });
            html += '</optgroup>';
        }
        
        // Add enhanced section
        if (enhancedVoices.length > 0) {
            html += '<optgroup label="‚ú® ENHANCED VOICES">';
            enhancedVoices.forEach(v => {
                html += `<option value="${v.index}">${v.voice.name} (${v.voice.lang})</option>`;
            });
            html += '</optgroup>';
        }
        
        // Add regular section
        if (regularVoices.length > 0) {
            html += '<optgroup label="üì± STANDARD VOICES">';
            regularVoices.forEach(v => {
                html += `<option value="${v.index}">${v.voice.name} (${v.voice.lang})</option>`;
            });
            html += '</optgroup>';
        }
        
        sel.innerHTML = html;
        
        // FORCE SET the specific voice for this character (idx = 0-4 for characters 1-5)
        const targetIndex = foundVoiceIndices[idx];
        sel.value = targetIndex;
        
        console.log(`Character ${idx + 1} set to voice index ${targetIndex}: ${voices[targetIndex].name}`);
    });
}

window.speechSynthesis.onvoiceschanged = loadVoices;
init(); setTimeout(loadVoices, 800);

function refreshVoices() {
    loadVoices();
    alert("‚úÖ Voices refreshed! Check the dropdowns for your new Premium & Enhanced voices.");
}

function showVoiceInspector() {
    const inspector = document.getElementById('voiceInspector');
    const voiceList = document.getElementById('voiceList');
    
    let html = '<div style="background:#111; padding:10px; border-radius:5px; margin-bottom:10px; color:#34C759;">';
    html += '<strong>INSTRUCTIONS:</strong><br>';
    html += '1. Find your voice below (Matilda, Ava, Zoe, Karen, Kate)<br>';
    html += '2. Note the INDEX number<br>';
    html += '3. Select it from the dropdown for each character<br>';
    html += '</div>';
    
    voices.forEach((v, i) => {
        const isLocal = v.localService ? 'üì• DOWNLOADED' : '‚òÅÔ∏è online';
        const lang = v.lang || 'unknown';
        html += `<div style="background:#222; padding:8px; margin:5px 0; border-radius:5px; border-left:3px solid ${v.localService ? '#34C759' : '#666'};">`;
        html += `<strong style="color:#AF52DE;">INDEX ${i}</strong>: ${v.name}<br>`;
        html += `<small style="color:#888;">${lang} | ${isLocal}</small>`;
        html += `</div>`;
    });
    
    voiceList.innerHTML = html;
    inspector.style.display = 'block';
    
    // Scroll to inspector
    inspector.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideVoiceInspector() {
    document.getElementById('voiceInspector').style.display = 'none';
}

function toggleMasterBeat() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    masterBeatOn = !masterBeatOn;
    const btn = document.getElementById('masterBeatBtn');
    if (masterBeatOn) {
        btn.textContent = "ü•Å BEAT IS ON";
        btn.classList.add('beat-active');
        playTick();
    } else {
        btn.textContent = "ü•Å BEAT IS OFF";
        btn.classList.remove('beat-active');
        if (beatTimeout) clearTimeout(beatTimeout);
    }
}

function playTick() {
    if (!masterBeatOn) return;
    const patternKey = document.getElementById(`beat_select_${currentActiveChar}`).value;
    const currentPattern = patterns[patternKey];
    const hit = currentPattern[patternPos % currentPattern.length];
    if (hit === 1) {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(65, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.6, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
    patternPos++;
    const speed = (60 / currentBPM) * 1000 / 4; 
    beatTimeout = setTimeout(playTick, speed);
}

async function startPerformance() {
    if (isRunning) return;
    isRunning = true;
    updateStartingBPM(document.getElementById('startBPM').value);
    
    while (isRunning) {
        for (let i = 1; i <= 5; i++) {
            if (!isRunning) break;
            currentActiveChar = i;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('active-char'));
            document.getElementById(`card_${i}`).classList.add('active-char');
            const vIdx = document.getElementById(`voice_${i}`).value;
            const fullText = document.getElementById(`text_${i}`).value;
            
            // Get the 3 phrases for this character
            const phrases = [
                document.getElementById(`c${i}_p1`).value,
                document.getElementById(`c${i}_p2`).value,
                document.getElementById(`c${i}_p3`).value
            ];
            
            // Process text with numbered insertions (*1, *2, *3)
            const segments = fullText.split(/(\*[123])/);
            
            for (let j = 0; j < segments.length; j++) {
                if (!isRunning) break;
                const segment = segments[j].trim();
                
                // Check if this is a phrase marker
                if (segment === '*1') {
                    await performSpeech(phrases[0], vIdx);
                } else if (segment === '*2') {
                    await performSpeech(phrases[1], vIdx);
                } else if (segment === '*3') {
                    await performSpeech(phrases[2], vIdx);
                } else if (segment.length > 0) {
                    // Regular text segment
                    await performSpeech(segment, vIdx);
                }
            }
        }
        currentBPM += 10;
        document.getElementById('bpmLabel').textContent = "CURRENT BPM: " + currentBPM;
    }
}

function performSpeech(text, vIdx) {
    return new Promise(resolve => {
        const u = new SpeechSynthesisUtterance(text);
        u.voice = voices[vIdx];
        if (text === text.toUpperCase() && text.length > 2) { u.pitch = 1.7; u.rate = 1.2; }
        u.onend = resolve; u.onerror = resolve;
        window.speechSynthesis.speak(u);
    });
}

function stopAll() {
    isRunning = false;
    masterBeatOn = false;
    if (beatTimeout) clearTimeout(beatTimeout);
    window.speechSynthesis.cancel();
    document.getElementById('masterBeatBtn').textContent = "ü•Å BEAT IS OFF";
    document.getElementById('masterBeatBtn').classList.remove('beat-active');
    document.querySelectorAll('.character-card').forEach(c => c.classList.remove('active-char'));
}

// LOGGING
function saveCurrentToLog() {
    const logName = prompt("Save Performance As:", "Entry " + new Date().toLocaleTimeString());
    if (!logName) return;
    const data = [];
    for (let i = 1; i <= 5; i++) {
        data.push({
            text: document.getElementById(`text_${i}`).value,
            p: [document.getElementById(`c${i}_p1`).value, document.getElementById(`c${i}_p2`).value, document.getElementById(`c${i}_p3`).value],
            beat: document.getElementById(`beat_select_${i}`).value,
            v: document.getElementById(`voice_${i}`).selectedIndex
        });
    }
    const savedLogs = JSON.parse(localStorage.getItem('poemLogs') || '[]');
    savedLogs.push({ name: logName, timestamp: new Date().toLocaleString(), data: data });
    localStorage.setItem('poemLogs', JSON.stringify(savedLogs));
    renderLog();
}

function renderLog() {
    const logContainer = document.getElementById('logItems');
    const savedLogs = JSON.parse(localStorage.getItem('poemLogs') || '[]');
    logContainer.innerHTML = savedLogs.length === 0 ? "<p style='color:#666'>No logs saved.</p>" : "";
    savedLogs.forEach((log, index) => {
        const item = document.createElement('div');
        item.className = 'log-item';
        item.innerHTML = `
            <strong>${log.name}</strong><br>
            <small style="color:#888">${log.timestamp}</small><br>
            <button onclick="loadLog(${index})">LOAD</button>
            <button style="background:#FF3B30" onclick="deleteLog(${index})">DEL</button>
        `;
        logContainer.appendChild(item);
    });
}

function loadLog(index) {
    const savedLogs = JSON.parse(localStorage.getItem('poemLogs') || '[]');
    const log = savedLogs[index].data;
    log.forEach((charData, i) => {
        const idx = i + 1;
        document.getElementById(`text_${idx}`).value = charData.text;
        document.getElementById(`c${idx}_p1`).value = charData.p[0];
        document.getElementById(`c${idx}_p2`).value = charData.p[1];
        document.getElementById(`c${idx}_p3`).value = charData.p[2];
        document.getElementById(`beat_select_${idx}`).value = charData.beat;
        document.getElementById(`voice_${idx}`).selectedIndex = charData.v;
    });
}

function deleteLog(index) {
    if(confirm("Delete?")) {
        const savedLogs = JSON.parse(localStorage.getItem('poemLogs') || '[]');
        savedLogs.splice(index, 1);
        localStorage.setItem('poemLogs', JSON.stringify(savedLogs));
        renderLog();
    }
}
</script>
</body>
</html>
